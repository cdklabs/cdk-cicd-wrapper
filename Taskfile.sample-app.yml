version: '3'

vars:
  DEVELOPMENT_DIR: "development"
  SAMPLES_APP_DIR: "samples"
  # Default sample app to use
  SAMPLE_APP: "ts-cdk-project-with-private-repository"
  STAGES_ENABLED: "DEV"

tasks:

  dev:info:
    desc: Prints information about the pipeline
    summary: Prints information about the pipeline
    silent: true
    cmds:
      - echo "Information:"
      - 'echo "AWS Region: ${AWS_REGION}"'
      - 'echo "AWS RES Account: ${ACCOUNT_RES}"'
      - 'echo "AWS Profile: $RES_ACCOUNT_AWS_PROFILE"'
      - 'echo "CDK Qualifier: ${CDK_QUALIFIER}"'
      - 'echo "Git Repository: ${GIT_REPOSITORY}"'
      - echo "Accounts:"
      - for: { var: STAGES_ENABLED, split: "," }
        cmd: 'echo "  - {{.ITEM}}: ${ACCOUNT_{{.ITEM}}} -- profile: ${{.ITEM}}_ACCOUNT_AWS_PROFILE"'
      - echo "===================================================="

  list:
    desc: List all available sample apps
    dir: '{{.SAMPLES_APP_DIR}}'
    silent: true
    cmds:
      - echo "Available sample apps:"
      - echo "-----------------------"
      - ls

  dev:clean:
    desc: Clean the build directory
    silent: true
    cmds:
      - rm -rf {{.DEVELOPMENT_DIR}}

  dev:create-development-dir:
    desc: Create the development directory
    internal: true
    silent: true
    cmds:
      - mkdir {{.DEVELOPMENT_DIR}}
    status:
      - test -d {{.DEVELOPMENT_DIR}}
  
  dev:init:
    desc: Initialize the development with {{.SAMPLE_APP}}
    requires:
      vars:
        - SAMPLE_APP
    cmds:
      - task: dev:clean
      - task: dev:create-development-dir
      - cp -r {{.SAMPLES_APP_DIR}}/{{.SAMPLE_APP}}/* {{.DEVELOPMENT_DIR}}

  dev:deploy:
    desc: Deploy the development with {{.SAMPLE_APP}}
    dir: '{{.SAMPLES_APP_DIR}}/{{.SAMPLE_APP}}'
    cmds:
      - cdk deploy --all

  dev:bootstrap:
    desc: Bootstrap the development for {{.SAMPLE_APP}}
    summary: |
      This task will bootstrap the AWS accounts to be able to deploy CDK applications.

      Get more information about CDK bootstrapping: https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping.html
    dir: '{{.SAMPLES_APP_DIR}}/{{.SAMPLE_APP}}'
    silent: true
    cmds:
      - echo "==============================================================="
      - echo "# Bootstrapping CDK for the pipeline {{.GIT_REPOSITORY}}        "
      - echo "==============================================================="
      - task: dev:info
      - task: dev:bootstrap:internal
      - echo "================================================================"


  dev:bootstrap:internal:
    internal: true
    desc: Internal task to bootstrap the AWS accounts to be able to deploy CDK applications
    dir: '{{.SAMPLES_APP_DIR}}/{{.SAMPLE_APP}}'
    preconditions:
      - sh: '[ `jq -r ''.context."@aws-cdk/core:bootstrapQualifier"'' cdk.json` = "$CDK_QUALIFIER" ]'
        msg: 'The bootstrap qualifier does not match the CDK_QUALIFIER variable. Please update the cdk.json file.'
    cmds:
      - task: dev:bootstrap:RES
      - for: { var: STAGES_ENABLED, split: "," } 
        task: dev:bootstrap:account
        vars:
          STAGE: '{{.ITEM}}'
          OPTS: --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess --trust ${ACCOUNT_RES}


  dev:bootstrap:RES:
    internal: true
    cmds:
      - task: dev:bootstrap:account
        vars:
          STAGE: RES

  dev:bootstrap:account:
    internal: true
    dir: '{{.SAMPLES_APP_DIR}}/{{.SAMPLE_APP}}'
    requires:
      vars:
        - CDK_QUALIFIER
        - AWS_REGION
        - STAGE
    preconditions:
      - sh: '[[ ! -z "${{.STAGE}}_ACCOUNT_AWS_PROFILE" ]]'
        msg: 'The environment {{.STAGE}} does not have an AWS profile defined. Please define it in the .env file.'
    cmds:
      - cdk bootstrap --profile ${{.STAGE}}_ACCOUNT_AWS_PROFILE --qualifier $CDK_QUALIFIER {{.OPTS}} aws://$ACCOUNT_{{.STAGE}}/${AWS_REGION}
  
  dev:build:
    desc: Build the development with {{.SAMPLE_APP}}
    dir: '{{.DEVELOPMENT_DIR}}'
    cmds:
      - npm install
      - npm run build